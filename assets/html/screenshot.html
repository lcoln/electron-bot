<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Screenshot</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background-size: contain;
    }
    .zoom-style {
      position: relative;
      margin-top: 50px;
      margin-left: 50px;
      border: 1px solid #FDEBA9;
      background-repeat: no-repeat;
    }
    .zoom-style:before {
      content: "";
      position: absolute;
      top: 50%;
      margin-top: -0.5px;
      width: 100%;
      height: 1px;
      background-color: #F6D76B;
    }
    .zoom-style:after {
      content: "";
      position: absolute;
      left: 50%;
      margin-left: -0.5px;
      width: 1px;
      height: 100%;
      background-color: #F6D76B;
    }
    .zoom-hidden {
      visibility: hidden;
    }
    .zoom-show {
      visibility: visible;
    }
    #capture-area {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
    }
  </style>
</head>
<body>
  <canvas id="capture-area"></canvas>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const imagePath = urlParams.get('path');
    document.body.style.backgroundImage = `url('file://${imagePath}')`;
  </script>
  <script>
    function adjustCanvasSize(canvas, ctx) {
      // 获取设备像素比
      const dpr = window.devicePixelRatio || 1;

      // 设置 canvas 的 CSS 尺寸
      canvas.style.width = window.innerWidth + 'px';
      canvas.style.height = window.innerHeight + 'px';

      // 设置 canvas 的实际绘制尺寸
      canvas.width = window.innerWidth * dpr;
      canvas.height = window.innerHeight * dpr;

      // 设置缩放比例
      ctx.scale(dpr, dpr);
    }
    class Draw {
      constructor(opts){
        this.canvas = document.getElementById('capture-area');
        this.ctx = this.canvas.getContext('2d');
        adjustCanvasSize(this.canvas, this.ctx)
        const rect = this.canvas.getBoundingClientRect();
        this.originX = opts.x - rect.left;
        this.originY = opts.y - rect.top;
        this.isEdit = false;
      }
      startPaint(){
      }
      paint(captureInfo){
        if (!this.canvas) return
        if (!this.isEdit) {
          this.isEdit = true
        }

        const { x, y } = captureInfo

        const rect = this.canvas.getBoundingClientRect();
        const endX = x - rect.left;
        const endY = y - rect.top;
        const width = endX - this.originX;
        const height = endY - this.originY;

        const ctx = this.canvas.getContext('2d');
        ctx.save()
        ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

        ctx.fillStyle = 'rgba(0,0,0,.5)'
        ctx.fillRect(0, 0, this.canvas.width, this.canvas.height)

        // 清除矩形区域的半透明背景
        ctx.clearRect(this.originX, this.originY, width, height);

        // ctx.restore()

        // 绘制矩形
        ctx.beginPath();
        ctx.strokeStyle = 'blue'; // 蓝色边框
        ctx.lineWidth = 2; // 矩形边框的宽度
        ctx.strokeRect(this.originX, this.originY, width, height);

        console.log({x: this.originX, y: this.originY, width, height})
      }
    }
  </script>
  <script>
    const { closeWindows } = window.screenshotApi
    const zoomSelector = document.createElement('div')
    const zoomSize = 120
    zoomSelector.style.width = `${zoomSize}px`
    zoomSelector.style.height = `${zoomSize}px`
    zoomSelector.style.backgroundImage = document.body.style.backgroundImage
    zoomSelector.classList.add('zoom-style')
    zoomSelector.classList.add('zoom-hidden')
    document.body.appendChild(zoomSelector)

    let captureAreaCtx = null

    function integer (num) {
      // 转成字符串
      let newnum = '';
      newnum = `${num}`;
      if (newnum.indexOf('.') === -1) {
        return { int: parseInt(num, 10), divisor: 1 };
      }
      // 分割字符串
      let len = newnum.split('.')[1].length;
      // 求10的倍数
      let total = 1;
      while (len !== 0) {
        total *= 10;
        len -= 1;
      }
      // 返回整数和10的倍数
      return { int: parseInt(`${total * num}`, 10), divisor: total };
    };
    function toPercent (num) {
      const res = integer(num);
      return `${((res.int * 100) / res.divisor).toFixed(2)}%`;
    };

    function mousemove(ev){
      if (!captureAreaCtx) return

      const x = ev.pageX
      const y = ev.pageY
      // console.log({x, y})
      zoomSelector.style.left = `${x}px`
      zoomSelector.style.top = `${y}px`

      const { width, height } = window.screen
      const xPercent = toPercent(x / width)
      const yPercent = toPercent(y / height)
      // console.log({xPercent, yPercent})
      zoomSelector.style.backgroundPosition = `${xPercent} ${yPercent}`
      // console.log({captureAreaCtx})
      captureAreaCtx.paint({ x: ev.clientX, y: ev.clientY })
    }
    function mouseenter(){
      if (!zoomSelector.classList.contains('zoom-show')) {
        zoomSelector.classList.add('zoom-show')
      }
      
      if (zoomSelector.classList.contains('zoom-hidden')) {
        zoomSelector.classList.remove('zoom-hidden')
      }
    }
    function mouseout(){
      if (zoomSelector.classList.contains('zoom-show')) {
        zoomSelector.classList.remove('zoom-show')
      }
      
      if (!zoomSelector.classList.contains('zoom-hidden')) {
        zoomSelector.classList.add('zoom-hidden')
      }
    }
    function mousedown(ev){
      if (captureAreaCtx) return
      captureAreaCtx = new Draw({ x: ev.clientX, y: ev.clientY })
      captureAreaCtx.startPaint()
      console.log(captureAreaCtx, 'mousedown111')
    }
    function mouseup(){
      if (captureAreaCtx.isEdit) {
        captureAreaCtx.isEdit = false
        return
      }
      
      captureAreaCtx = null
      console.log(captureAreaCtx, zoomSelector, 'mouseup')

      zoomSelector && document.body.removeChild(zoomSelector)
    }

    async function handleKeyDown (event) {
      const { key } = event;
      switch (key) {
        case 'Escape':
          closeWindows()
          break;
        default:
          break;
      }
    };
    document.addEventListener('mouseenter', mouseenter)
    // document.addEventListener('mouseout', mouseout)
    
    document.addEventListener('mousemove', mousemove)
    document.addEventListener('mousedown', mousedown)
    document.addEventListener('mouseup', mouseup)

    document.addEventListener('keydown', handleKeyDown);
  </script>
</body>
</html>